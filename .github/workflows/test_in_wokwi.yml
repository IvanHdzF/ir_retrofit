name: Run Test Application (Wokwi)

on:
  workflow_call:
    secrets:
      WOKWI_CLI_TOKEN:
        required: true
  workflow_dispatch: {}

jobs:
  run-target:
    name: Run Test App in simulation
    runs-on: ubuntu-20.04
    env:
          WOKWI_CLI_TOKEN: ${{ secrets.WOKWI_CLI_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        espidf_target:
          - esp32s3
        app_name: [test_evt_bus]   # adjust to what exists in apps/

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Skip artifact download when running under act (no runtime token)
      - name: Download files / artifacts from build job
        if: ${{ github.actor != 'nektos/act' }}
        uses: actions/download-artifact@v4
        with:
          name: apps/test_evt_bus_bin_${{ matrix.espidf_target }}
          path: apps/test_evt_bus/build

      # Only on ACT
      - name: Build with ESP-IDF
        if: ${{ github.actor == 'nektos/act' }}
        uses: espressif/esp-idf-ci-action@v1
        with:
          esp_idf_version: "latest"
          target: ${{ matrix.espidf_target }}
          path: "."
          command: >
            idf.py -DAPP_NAME=test_evt_bus -B apps/test_evt_bus/build build

      - name: Install the Wokwi CLI
        run: curl -L https://wokwi.com/ci/install.sh | sh

      - name: Set up Python
        if: ${{ env.ACT == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python packages for PyTest
        env:
          PIP_PREFER_BINARY: true
          PIP_INDEX_URL: "https://dl.espressif.com/pypi/"
          PIP_EXTRA_INDEX_URL: "https://pypi.org/simple"
        run: python -m pip install -r apps/test_evt_bus/requirements.txt

      - name: Run Test App in Wokwi Simulation
        if: ${{ env.WOKWI_CLI_TOKEN != '' }}
        working-directory: apps/test_evt_bus
        run: |
          ls -l
          pytest \
          --junit-xml=./test_app_results_esp32s3.xml \
          --embedded-services idf,wokwi \
          --target=esp32s3 \

      - name: Skip Wokwi (no token)
        if: ${{ env.WOKWI_CLI_TOKEN == '' }}
        run: echo "Skipping Wokwi simulation (no token configured)"


      # Skip artifact upload when running under act (no runtime token)
      - name: Upload test results for publish-results job
        if: ${{ always() && github.actor != 'nektos/act' }}
        uses: actions/upload-artifact@v4
        with:
          name: apps/test_evt_bus_results_wokwi${{ matrix.espidf_target }}
          path: apps/test_evt_bus/*.xml

  publish-results:
    name: Publish Test App results
    needs: run-target
    runs-on: ubuntu-20.04
    if: ${{ always() && github.actor != 'nektos/act' }}
    steps:
      - name: Download Test results
        uses: actions/download-artifact@v4
        with:
          path: test_results

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: test_results/**/*.xml
